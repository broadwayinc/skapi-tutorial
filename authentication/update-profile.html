<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/skapi-js@latest/dist/skapi.js"></script>
<script src="../service.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-init-css@latest/init.css">
<link rel="stylesheet" href="../custom.css">

<main id="main_page">
    <form action='../index.html' onsubmit="
        disableForm(this, true);
        skapi.updateProfile(event).catch(err=>alert(err.message)).finally(()=>disableForm(this, false));
    ">
        <div class="spaceBetween">
            <h2>Update Profile</h2>
            <a href="../index.html">Back</a>
        </div>
        <small>
            Last login time: <span id="span_logTime"></span>
        </small>
        <hr>
        <table>
            <tr>
                <td>
                    <span>
                        Profile Picture
                    </span>
                </td>
                <td>
                    <a class='imgLink' href="profile-pic.html">
                        <img src="" id="img_profilePic" class="profilePic">
                        Update Profile Picture
                    </a>
                    <style>
                        a.imgLink {
                            text-decoration: none;
                        }
                    </style>
                </td>
            </tr>
            <tr>
                <td>
                    <span>
                        Login Email
                    </span>
                </td>
                <td>
                    <input id='input_email' name="email" placeholder='your@email.com' required>

                </td>
            </tr>
            <tr>
                <td>
                    <span>
                        Your Name
                    </span>
                </td>
                <td>
                    <input id='input_name' name="name" placeholder='(optional)'>
                </td>
            </tr>
            <tr>
                <td>
                    <span>
                        Birthday
                    </span>
                </td>
                <td>
                    <input id='input_birthdate' name="birthdate" type="date">
                </td>
            </tr>
            <tr>
                <td>
                    <span>
                        Email to Public
                    </span>
                </td>
                <td>
                    <input id='input_emailPublic' name="email_public" type="checkbox">
                    <small class="inlineBlock">(Email verification required)</small>
                    <style>
                        #input_emailPublic+small {
                            display: none;
                        }
                    </style>
                </td>
            </tr>
            <tr>
                <td>
                    <span>
                        Email Verified
                    </span>
                </td>
                <td>
                    <span id="span_emailVerified"></span>
                    <ins class='clickable inlineBlock' onclick="
                        let userConfirm = confirm(`We will send a verification email to ${user.email}. Continue?`);
                        if(userConfirm) {
                            skapi.verifyEmail().then(()=>location.href = 'email-verification.html').catch(err=>alert(err=>alert(err.message)));
                        }
                    ">
                        <small>
                            (Click to verify your email)
                        </small>
                        <style>
                            #span_emailVerified.false::before {
                                content: 'No ';
                                display: inline-block;
                            }

                            #span_emailVerified.true::after {
                                content: 'Yes';
                            }

                            #span_emailVerified.true+ins {
                                display: none;
                            }
                        </style>
                    </ins>
                </td>
            </tr>
            <tr>
                <td>
                    <span>
                        Password
                    </span>
                </td>
                <td>
                    <a href="change-password.html">Change Password</a>
                </td>
            </tr>
        </table>
        <br>
        <div class="alignRight">
            <input type="submit" value="Update">
            <br>
            <br>
            <small>
                <a href="remove-account.html">Remove Account</a>
            </small>
        </div>
    </form>
</main>

<script>
    let user;
    checkProfile({
        kickRoute: '../index.html',
        kickUser: 'unsigned'
    }).then(u => {
        user = u;
        if (!user) {
            location.href = '../index.html';
        }

        span_logTime.textContent = new Date(user.log * 1000).toLocaleString();

        input_email.value = user.email || '';
        input_name.value = user.name || '';
        input_birthdate.value = user.birthdate || '';
        img_profilePic.src = user.picture || "";

        span_emailVerified.classList.add(user.email_verified.toString());
        if (!user.email_verified) {
            input_emailPublic.disabled = true;
        }

        input_emailPublic.checked = user.email_public && user.email_verified;
    });
</script>