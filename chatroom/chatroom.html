<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/skapi-js@beta/dist/skapi.js"></script>
<script src="../service.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-init-css@latest/init.css">
<link rel="stylesheet" href="../custom.css">
<script>
    let user = checkProfile({
        kickRoute: '../index.html',
        kickUser: 'unsigned'
    });
</script>
<dialog id="privateMsg">
    <small>Private Message: <span id="msgTo"></span></small>
    <p id="privateMsgBox"></p>
    <form onsubmit="skapi.postRealtime(event, privateChat).then(()=>{this.reset(); privateMsg.close();})">
        <input type="text" name='msg' placeholder="Say something">
        <input type="submit" value="Send">
    </form>
    <small class='clickable' onclick="privateMsg.close()">Close</small>
</dialog>
<main>
    <div>
        <div class="spaceBetween">
            <h2>Chat Room</h2>
            <a href="../index.html">Back</a>
        </div>
        <div id="chatBox">
            <section id="chatSection">
                <div id="chat"></div>
                <form onsubmit="skapi.postRealtime(event, 'chat').then(()=>this.reset())">
                    <input id='inputMsg' type="text" name='msg' placeholder="Say something" disabled>
                    <input id='sendMsg' type="submit" value="Send" disabled>
                </form>
            </section>
            <section id="joinedUsers"></section>
        </div>
    </div>
</main>
<script>
    let privateChat = '';
    let userInfo = {};
    function getUserInfo(user_id) {
        if (!userInfo[user_id]) {
            userInfo[user_id] = skapi.getUsers({
                searchFor: 'user_id',
                value: user_id
            }).then(user => {
                if (user.list.length === 0) {
                    return {
                        email: 'User not found',
                        name: 'User not found',
                        picture: ''
                    };
                }
                else {
                    return user.list[0];
                }
            });
        }

        return userInfo[user_id];
    }

    let listUser = async (u) => {
        if (document.getElementById(u.user_id)) {
            return;
        }

        let me = await user;
        if (u.user_id === me.user_id) {
            return;
        }

        let joinedHtml = /*html*/ `
                        <img src="${u.picture || ''}" class="profilePic">
                        <b>${u.name}</b>
                    `;
        let joinedDiv = document.createElement('div');
        joinedDiv.id = u.user_id;
        joinedDiv.classList.add('clickable');
        joinedDiv.innerHTML = joinedHtml;
        joinedUsers.append(joinedDiv);

        joinedDiv.onclick = () => {
            privateMsg.showModal();
            msgTo.textContent = u.name;
            privateChat = u.user_id;
            privateMsgBox.innerHTML = '';
        }
    }

    let rtCallback = async (rt) => {
        let me = await user;

        if (rt.status === 'notice') {
            if (rt.message.includes('joined the message group.')) {
                return getUserInfo(rt.sender).then(async u => {
                    let html = /*html*/ `
                    <div class='alignCenter'>-- ${u.name} has joined the chat --</div>
                `;
                    let div = document.createElement('div');
                    div.innerHTML = html;
                    chat.append(div);
                    chat.scrollTop = chat.scrollHeight;

                    listUser(u);
                });
            }
            else if (rt.message.includes('left the message group.')) {
                return getUserInfo(rt.sender).then(async u => {
                    let html = /*html*/ `
                    <div class='alignCenter'>-- ${u.name} has left the chat --</div>
                `;
                    let div = document.createElement('div');
                    div.innerHTML = html;
                    chat.append(div);
                    chat.scrollTop = chat.scrollHeight;

                    let joinedDiv = document.getElementById(rt.sender);
                    if (joinedDiv) {
                        joinedDiv.remove();
                    }
                });
            }
        }

        if (rt.status === 'message') {
            let sender = await getUserInfo(rt.sender);
            let html = /*html*/ `
                <span class='inlineBlock'>
                    <img src="${sender.picture || ''}" class="profilePic">
                    <b>${sender.name}</b>
                </span>
                <br>
                <span class='inlineBlock'>${rt.message.msg}</span>
            `;
            let div = document.createElement('div');
            div.innerHTML = html;
            div.classList.add('msg');

            let me = await user;
            if (rt.sender === me.user_id) {
                div.classList.add('alignRight');
            }
            chat.append(div);
            chat.scrollTop = chat.scrollHeight;
        }

        if (rt.status === 'private') {
            if (me.user_id === rt.sender) {
                return;
            }

            let u = await getUserInfo(rt.sender);
            privateMsg.showModal();
            msgTo.textContent = u.name;
            privateChat = u.user_id;
            privateMsgBox.innerHTML = rt.message.msg;
        }
    }

    skapi.connectRealtime(rtCallback);
    setTimeout(() =>
        skapi.joinRealtime({group: 'chat'}).then(() => {
            inputMsg.disabled = false;
            sendMsg.disabled = false;
            skapi.getRealtimeUsers({
                group: 'chat'
            }).then(u => {
                u.list.forEach(uid => getUserInfo(uid).then(listUser));
            });
        }), 1000);

</script>
<style>
    main {
        width: 100%;
        text-align: center;
        padding: 8px;
        box-sizing: border-box;
    }

    main>div {
        display: inline-block;
        text-align: left;
        width: 600px;
        max-width: 100%;
    }

    #chatBox {
        display: flex;
    }

    #chatSection {
        flex-grow: 1;
    }

    #joinedUsers>div {
        white-space: nowrap;
    }

    #chat {
        height: 60vh;
        padding: 8px;
        overflow-y: scroll;
        background-color: white;
    }

    form {
        display: flex;
    }

    input[type="text"] {
        width: 100%;
    }

    .msg>* {
        text-align: left;
    }
</style>